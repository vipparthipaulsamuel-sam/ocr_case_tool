<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OCR Case Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      .ocr-chip-box { min-height: 140px; background: #fafafa; }
      .ocr-chip {
        display:inline-block; margin:3px; padding:3px 6px; border:1px solid #ddd;
        border-radius:999px; background:#fff; cursor:grab; user-select:none; font-size:.85rem;
      }
      .ocr-chip:active { cursor:grabbing; }
      .droppable { border:1px solid #ced4da; }
      .droppable.drop-target { outline:2px dashed #0d6efd; outline-offset:2px; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('dashboard') if session.get('user_id') else url_for('index') }}">OCR Case Tool</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            {% if session.get('user_id') %}
              <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a></li>
              {% if user and user.role == 'admin' %}
                <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_dashboard') }}">Admin</a></li>
              {% endif %}
              <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
            {% else %}
              <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">Login</a></li>
              <li class="nav-item"><a class="nav-link" href="{{ url_for('register') }}">Register</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Drag & Drop mapper logic -->
    <script>
    (function () {
      let lastFocused = null;

      document.addEventListener('focusin', (e) => {
        const el = e.target;
        if (el.matches('.droppable, input.droppable, textarea.droppable')) {
          lastFocused = el;
        }
      });

      // chips draggable + clickable
      document.addEventListener('dragstart', (e) => {
        const chip = e.target.closest('.ocr-chip');
        if (!chip) return;
        e.dataTransfer.setData('text/plain', chip.dataset.token || chip.textContent.trim());
        e.dataTransfer.effectAllowed = 'copy';
      });

      document.addEventListener('click', (e) => {
        const chip = e.target.closest('.ocr-chip');
        if (!chip || !lastFocused) return;
        const token = chip.dataset.token || chip.textContent.trim();
        pasteToken(lastFocused, token);
      });

      // droppable inputs
      document.addEventListener('dragover', (e) => {
        const target = e.target.closest('.droppable');
        if (!target) return;
        e.preventDefault();
        target.classList.add('drop-target');
      });
      document.addEventListener('dragleave', (e) => {
        const target = e.target.closest('.droppable');
        if (!target) return;
        target.classList.remove('drop-target');
      });
      document.addEventListener('drop', (e) => {
        const target = e.target.closest('.droppable');
        if (!target) return;
        e.preventDefault();
        target.classList.remove('drop-target');
        const token = e.dataTransfer.getData('text/plain');
        pasteToken(target, token);
      });

      function pasteToken(target, token) {
        if (!token) return;
        // Normalize by field type
        if (target.name === 'amount_inr') {
          token = token.replace(/[â‚¹,]/g, '');
        }
        if (target.name === 'date') {
          const m = token.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
          if (m) {
            const dd = m[1].padStart(2,'0');
            const mm = m[2].padStart(2,'0');
            const yy = m[3].length === 2 ? ('20' + m[3]) : m[3];
            token = `${yy}-${mm}-${dd}`;  // yyyy-mm-dd
          }
        }
        if (target.name === 'time') {
          const t = token.trim().toLowerCase();
          const mm = t.match(/^(\d{1,2}):(\d{2})\s*(am|pm)?$/i);
          if (mm) {
            let h = parseInt(mm[1],10), m = mm[2], ap = (mm[3]||'').toLowerCase();
            if (ap === 'pm' && h < 12) h += 12;
            if (ap === 'am' && h === 12) h = 0;
            token = `${String(h).padStart(2,'0')}:${m}`;
          }
        }

        if (target.tagName === 'TEXTAREA') {
          target.value = (target.value ? target.value + ' ' : '') + token;
        } else {
          target.value = token;
        }
        target.focus();
      }
    })();
    </script>
  </body>
</html>